import{_ as s}from"./chunks/plugin-vue_export-helper.DlAUqK2U.js";import{c as e,o as i,X as n}from"./chunks/vendor-vueuse.XPft87tp.js";const m=JSON.parse('{"title":"解决 npm link 本地代码后 react 库存在多份实例的问题","description":"","frontmatter":{},"headers":[],"relativePath":"fragment/react-duplicate.md","filePath":"fragment/react-duplicate.md","lastUpdated":1771466668000}'),l={name:"fragment/react-duplicate.md"};function t(p,a,r,h,o,c){return i(),e("div",null,a[0]||(a[0]=[n(`<h1 id="解决-npm-link-本地代码后-react-库存在多份实例的问题" tabindex="-1">解决 npm link 本地代码后 react 库存在多份实例的问题 <a class="header-anchor" href="#解决-npm-link-本地代码后-react-库存在多份实例的问题" aria-label="Permalink to &quot;解决 npm link 本地代码后 react 库存在多份实例的问题&quot;">​</a></h1><h2 id="非法-hook-调用错误" tabindex="-1">非法 Hook 调用错误 <a class="header-anchor" href="#非法-hook-调用错误" aria-label="Permalink to &quot;非法 Hook 调用错误&quot;">​</a></h2><p>在调试本地组件库代码时，link 到主项目时报错了如下错误</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes dracula vitesse-black vp-code" tabindex="0"><code><span class="line"><span>Error: Invalid hook call. Hooks can only be called inside of the body of a function component. This could happen for one of the following reasons:</span></span>
<span class="line"><span>1. You might have mismatching versions of React and the renderer (such as React DOM)</span></span>
<span class="line"><span>2. You might be breaking the Rules of Hooks</span></span>
<span class="line"><span>3. You might have more than one copy of React in the same app See https://fb.me/react-invalid-hook-call for tips about how to debug and fix this problem.</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>但是将代码发布到本地仓库后，install 下来是不会有问题的。</p><h2 id="报错原因" tabindex="-1">报错原因 <a class="header-anchor" href="#报错原因" aria-label="Permalink to &quot;报错原因&quot;">​</a></h2><p>React 官方文档上解释了这个原因。</p><blockquote><p>为了使 Hook 正常工作，你应用代码中的 react 依赖以及 react-dom 的 package 内部使用的 react 依赖，必须解析为同一个模块。</p></blockquote><p>也就是说，在你的应用里找到了两份 react 实例，并且 react-dom 中引用的 react 实例与直接 import 的 react 实例不是同一份。对应到我报错的场景里，就是 link 到本地组件库时，组件库中 import 了一份 react-dom, 而这一份 react-dom 引用的 react 实例，是本地组件库中安装的 react 实例。而非主应用中安装的那一份 react 实例。</p><h2 id="为什么-npm-install-没有问题-npm-link-有问题" tabindex="-1">为什么 npm install 没有问题，npm link 有问题 <a class="header-anchor" href="#为什么-npm-install-没有问题-npm-link-有问题" aria-label="Permalink to &quot;为什么 npm install 没有问题，npm link 有问题&quot;">​</a></h2><p>npm install 在安装依赖的时候，会合并相同依赖，安装在最外层的 node_modules 中。所以只有一份依赖。而 npm link 是直接引用本地目录，本地目录的 node_modules 会和主项目的 node_modules 同时存在两份相同的引用。</p><h2 id="怎么解决这个问题" tabindex="-1">怎么解决这个问题 <a class="header-anchor" href="#怎么解决这个问题" aria-label="Permalink to &quot;怎么解决这个问题&quot;">​</a></h2><p>要解决这个问题，就需要将组件库 react-dom 依赖的 react 指向主项目 node_modules 中安装的那一份 react 实例。我们可以通过两种方式来完成这个操作。</p><h3 id="使用-link-的方式将组件库的-react-依赖指向到主项目的-react-依赖" tabindex="-1">使用 link 的方式将组件库的 react 依赖指向到主项目的 react 依赖 <a class="header-anchor" href="#使用-link-的方式将组件库的-react-依赖指向到主项目的-react-依赖" aria-label="Permalink to &quot;使用 link 的方式将组件库的 react 依赖指向到主项目的 react 依赖&quot;">​</a></h3><div class="language-shell vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes dracula vitesse-black vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#8BE9FD;--shiki-dark:#B8A965;">cd</span><span style="--shiki-light:#F8F8F2;--shiki-dark:#DBD7CACC;"> [PACKAGE]</span></span>
<span class="line"><span style="--shiki-light:#50FA7B;--shiki-dark:#80A665;">npm</span><span style="--shiki-light:#F1FA8C;--shiki-dark:#C98A7D;"> link</span><span style="--shiki-light:#F8F8F2;--shiki-dark:#DBD7CACC;"> [PROJECT]/node_modules/react</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="使用-alias-为-nodejs-指定-react-加载目录" tabindex="-1">使用 alias 为 Nodejs 指定 react 加载目录 <a class="header-anchor" href="#使用-alias-为-nodejs-指定-react-加载目录" aria-label="Permalink to &quot;使用 alias 为 Nodejs 指定 react 加载目录&quot;">​</a></h3><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes dracula vitesse-black vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6272A4;--shiki-dark:#758575DD;">// /build/wepack.base.config.js</span></span>
<span class="line"><span style="--shiki-light:#FF79C6;--shiki-dark:#CB7676;">const</span><span style="--shiki-light:#F8F8F2;--shiki-dark:#BD976A;"> config</span><span style="--shiki-light:#FF79C6;--shiki-dark:#444444;"> =</span><span style="--shiki-light:#F8F8F2;--shiki-dark:#444444;"> {</span></span>
<span class="line"><span style="--shiki-light:#F8F8F2;--shiki-dark:#B8A965;">  alias</span><span style="--shiki-light:#FF79C6;--shiki-dark:#444444;">:</span><span style="--shiki-light:#F8F8F2;--shiki-dark:#444444;"> {</span></span>
<span class="line"><span style="--shiki-light:#F8F8F2;--shiki-dark:#B8A965;">    react</span><span style="--shiki-light:#FF79C6;--shiki-dark:#444444;">:</span><span style="--shiki-light:#F8F8F2;--shiki-dark:#BD976A;"> path</span><span style="--shiki-light:#F8F8F2;--shiki-dark:#444444;">.</span><span style="--shiki-light:#50FA7B;--shiki-dark:#80A665;">join</span><span style="--shiki-light:#F8F8F2;--shiki-dark:#444444;">(</span><span style="--shiki-light:#F8F8F2;--shiki-dark:#BD976A;">__dirname</span><span style="--shiki-light:#F8F8F2;--shiki-dark:#444444;">,</span><span style="--shiki-light:#E9F284;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#F1FA8C;--shiki-dark:#C98A7D;">../node_modules/react</span><span style="--shiki-light:#E9F284;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#F8F8F2;--shiki-dark:#444444;">),</span></span>
<span class="line"><span style="--shiki-light:#F8F8F2;--shiki-dark:#444444;">  },</span></span>
<span class="line"><span style="--shiki-light:#F8F8F2;--shiki-dark:#444444;">};</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div>`,17)]))}const u=s(l,[["render",t]]);export{m as __pageData,u as default};
